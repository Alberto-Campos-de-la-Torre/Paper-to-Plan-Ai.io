<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaperToPlan Companion</title>

    <!-- iOS / PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PaperToPlan">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/000000/note.png">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        p {
            color: #aaa;
            margin-bottom: 30px;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn {
            border: 2px solid #4CAF50;
            color: white;
            background-color: transparent;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #4CAF50;
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }

        #status {
            margin-top: 20px;
            font-weight: bold;
            min-height: 24px;
        }

        .success {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
        }

        .loading {
            color: #FF9800;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div id="login-view"
        style="display:flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
        <div class="icon">üîí</div>
        <h1>Acceso Seguro</h1>
        <p>Ingresa tu Usuario y PIN</p>
        <input type="text" id="userInput" placeholder="Usuario"
            style="font-size: 20px; padding: 10px; text-align: center; width: 200px; border-radius: 10px; border: none; margin-bottom: 10px;">
        <input type="tel" id="pinInput" placeholder="PIN (4 d√≠gitos)" maxlength="4"
            style="font-size: 24px; padding: 10px; text-align: center; width: 150px; border-radius: 10px; border: none; margin-bottom: 20px;">
        <button class="btn" onclick="login()">Entrar</button>
        <p id="login-error" class="error" style="display:none; margin-top: 10px;">Usuario o PIN Incorrecto</p>
    </div>

    <div id="home-view" style="display:none;">
        <div class="icon">üì∏</div>
        <h1>PaperToPlan AI</h1>
        <p>Sube una foto o usa tu c√°mara</p>

        <div class="upload-btn-wrapper">
            <button class="btn">üì∑ Tomar Foto</button>
            <input type="file" name="file" id="fileInput" accept="image/*" capture="environment">
        </div>

        <div class="upload-btn-wrapper" style="margin-top: 15px;">
            <button class="btn secondary">üñºÔ∏è Galer√≠a</button>
            <input type="file" name="file" id="galleryInput" accept="image/*">
        </div>

        <div class="upload-btn-wrapper" style="margin-top: 15px;">
            <button id="recordBtn" class="btn" style="border-color: #FF5722; color: #FF5722;">üéôÔ∏è Grabar Voz</button>
        </div>
        <p id="recording-time" style="display:none; color: #FF5722; font-weight: bold; margin-top: 5px;">00:00</p>

        <br><br>
        <button class="btn secondary" onclick="showNotesList()">üìÇ Ver Notas</button>
        <br><br>
        <button class="btn small" onclick="logout()"
            style="background:none; border:none; color:#666; font-size:12px;">Cerrar Sesi√≥n</button>

        <div id="status"></div>
    </div>

    <div id="list-view" style="display:none; width: 100%; max-width: 600px; padding: 20px;">
        <button class="btn small" onclick="showHome()">‚¨ÖÔ∏è Volver</button>
        <h2>Mis Notas</h2>
        <div id="notes-container" style="text-align: left;"></div>
    </div>

    <div id="detail-view"
        style="display:none; width: 100%; max-width: 600px; padding: 20px; text-align: left; overflow-y: auto; max-height: 100vh;">
        <button class="btn small" onclick="showNotesList()">‚¨ÖÔ∏è Volver a Lista</button>
        <h2 id="detail-title">Detalle de Nota</h2>
        <div id="detail-content" style="word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"></div>
    </div>

    <script>
        // Helper function to escape HTML and prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const fileInput = document.getElementById('fileInput');
        const galleryInput = document.getElementById('galleryInput');
        const statusDiv = document.getElementById('status');
        let currentPIN = localStorage.getItem('paper_pin');
        let currentUser = localStorage.getItem('paper_user');
        let ws = null;

        // Init
        if (currentPIN && currentUser) {
            showHome();
            connectWebSocket();
        }

        async function login() {
            const pin = document.getElementById('pinInput').value;
            const user = document.getElementById('userInput').value;

            if (pin.length !== 4 || user.length === 0) {
                document.getElementById('login-error').textContent = 'Please enter username and 4-digit PIN';
                document.getElementById('login-error').style.display = 'block';
                return;
            }

            // Validate credentials with server
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'X-Auth-User': user,
                        'X-Auth-PIN': pin
                    }
                });

                if (response.ok) {
                    // Login successful
                    currentPIN = pin;
                    currentUser = user;
                    localStorage.setItem('paper_pin', pin);
                    localStorage.setItem('paper_user', user);
                    document.getElementById('login-error').style.display = 'none';
                    showHome();
                    connectWebSocket();
                } else {
                    // Login failed
                    document.getElementById('login-error').textContent = 'Invalid username or PIN';
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').textContent = 'Connection error. Please try again.';
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('paper_pin');
            localStorage.removeItem('paper_user');
            if (ws) ws.close();
            location.reload();
        }

        function getHeaders() {
            return {
                'X-Auth-PIN': currentPIN,
                'X-Auth-User': currentUser
            };
        }

        async function handleAuthError(response) {
            if (response.status === 401) {
                alert("Sesi√≥n expirada o PIN incorrecto");
                logout();
                throw new Error("Unauthorized");
            }
            return response;
        }

        // --- WebSocket ---
        function connectWebSocket() {
            if (!currentUser) return;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${currentUser}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log("WebSocket connected");
                // Send ping every 30s to keep alive
                setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) ws.send("ping");
                }, 30000);
            };

            ws.onmessage = (event) => {
                if (event.data === "pong") return;

                if (event.data === "processing_complete") {
                    showToast("‚úÖ Procesamiento completado en PC");
                    // If we are in list view, refresh it
                    if (document.getElementById('list-view').style.display === 'block') {
                        showNotesList();
                    }
                }
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected. Reconnecting in 5s...");
                setTimeout(connectWebSocket, 5000);
            };
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = '#4CAF50';
            toast.style.color = 'white';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '20px';
            toast.style.zIndex = '1000';
            toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Navigation
        function showHome() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'none';
        }

        async function showNotesList() {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            document.getElementById('detail-view').style.display = 'none';

            const container = document.getElementById('notes-container');
            container.innerHTML = '<p class="loading">Cargando notas...</p>';

            try {
                let response = await fetch('/api/notes', { headers: getHeaders() });
                response = await handleAuthError(response);
                const notes = await response.json();

                container.innerHTML = '';
                if (notes.length === 0) {
                    container.innerHTML = '<p>No hay notas a√∫n.</p>';
                    return;
                }

                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    const title = note.ai_analysis?.title || 'Sin t√≠tulo';
                    const status = note.status;
                    const statusColor = status === 'processed' ? '#4CAF50' : status === 'error' ? '#f44336' : '#FF9800';
                    const statusText = status === 'processed' ? 'Completado' : status === 'error' ? 'Error' : 'Pendiente';

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                            <strong style="font-size: 1.1em; color: #fff;">${title}</strong>
                            <span class="status-${status}" style="background: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; color: white;">${statusText}</span>
                        </div>
                        <p style="font-size: 0.85em; color: #aaa; margin: 5px 0;">
                            ${note.implementation_time || 'Sin tiempo estimado'} ‚Ä¢ ${new Date(note.created_at).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}
                        </p>
                    `;
                    card.onclick = () => showNoteDetail(note.id);
                    container.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="error">Error al cargar notas.</p>';
            }
        }

        async function showNoteDetail(id) {
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';

            const content = document.getElementById('detail-content');
            const titleElement = document.getElementById('detail-title');
            content.innerHTML = '<p class="loading">Cargando detalle...</p>';

            try {
                let response = await fetch(`/api/notes/${id}`, { headers: getHeaders() });
                response = await handleAuthError(response);
                const note = await response.json();

                // Parse ai_analysis if it's a string
                let analysis = {};
                if (note.ai_analysis) {
                    if (typeof note.ai_analysis === 'string') {
                        try {
                            analysis = JSON.parse(note.ai_analysis);
                        } catch (e) {
                            console.error('Error parsing ai_analysis:', e);
                            analysis = {};
                        }
                    } else {
                        analysis = note.ai_analysis;
                    }
                }

                const title = analysis.title || `Nota #${note.id}`;

                // Update title in the header
                if (titleElement) {
                    titleElement.textContent = title;
                }

                // Build stack tecnol√≥gico
                let stackHtml = 'Sin stack recomendado';
                if (analysis.recommended_stack) {
                    if (Array.isArray(analysis.recommended_stack)) {
                        stackHtml = analysis.recommended_stack.map(item => `<span style="background: #2196F3; padding: 5px 10px; border-radius: 15px; margin: 5px 5px 5px 0; display: inline-block; font-size: 0.9em;">${item}</span>`).join('');
                    } else {
                        stackHtml = analysis.recommended_stack;
                    }
                }

                // Build consideraciones t√©cnicas
                let considerationsHtml = 'Sin consideraciones t√©cnicas';
                if (analysis.technical_considerations) {
                    if (Array.isArray(analysis.technical_considerations)) {
                        considerationsHtml = '<ul style="margin: 10px 0; padding-left: 20px;">' +
                            analysis.technical_considerations.map(item => `<li style="margin: 5px 0;">${item}</li>`).join('') +
                            '</ul>';
                    } else {
                        considerationsHtml = analysis.technical_considerations;
                    }
                }

                // Status info
                const statusColor = note.status === 'processed' ? '#4CAF50' : note.status === 'error' ? '#f44336' : '#FF9800';
                const statusText = note.status === 'processed' ? 'Completado' : note.status === 'error' ? 'Error' : 'Pendiente';
                const scoreColor = (analysis.feasibility_score || 0) >= 80 ? '#4CAF50' : (analysis.feasibility_score || 0) >= 50 ? '#FF9800' : '#f44336';

                content.innerHTML = `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #4CAF50; font-size: 1.3em;">${title}</h3>
                            <span style="background: ${statusColor}; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; color: white; font-weight: bold;">${statusText}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <p style="margin: 5px 0; color: #aaa; font-size: 0.9em;"><strong>Tiempo Estimado:</strong></p>
                                <p style="margin: 5px 0; color: #fff; font-size: 1em;">${note.implementation_time || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 5px 0; color: #aaa; font-size: 0.9em;"><strong>Score de Viabilidad:</strong></p>
                                <p style="margin: 5px 0; color: ${scoreColor}; font-size: 1.2em; font-weight: bold;">${analysis.feasibility_score || 0}/100</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; overflow: visible;">
                        <h4 style="margin-top: 0; color: #2196F3;">üìù Resumen Ejecutivo</h4>
                        <p style="line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%; overflow: visible; text-overflow: clip;">${escapeHtml(analysis.summary || 'Sin resumen')}</p>
                    </div>
                    
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; overflow: visible;">
                        <h4 style="margin-top: 0; color: #2196F3;">üíª Stack Tecnol√≥gico Recomendado</h4>
                        <div style="margin-top: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%; overflow: visible;">${stackHtml}</div>
                    </div>
                    
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; overflow: visible;">
                        <h4 style="margin-top: 0; color: #2196F3;">üîß Consideraciones T√©cnicas</h4>
                        <div style="margin-top: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%; overflow: visible;">${considerationsHtml}</div>
                    </div>
                    
                    ${note.raw_text ? `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; overflow: visible;">
                        <h4 style="margin-top: 0; color: #2196F3;">üìÑ Texto Extra√≠do</h4>
                        <p style="line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; overflow: visible; text-overflow: clip;">${escapeHtml(note.raw_text)}</p>
                    </div>
                    ` : ''}
                `;
            } catch (e) {
                console.error(e);
                content.innerHTML = '<p class="error">Error al cargar detalle.</p>';
            }
        }

        // --- Image Compression ---
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 1920;
                const maxHeight = 1920;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7); // 70% quality
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleUpload(file) {
            if (!file) return;

            statusDiv.className = 'loading';
            statusDiv.textContent = '‚è≥ Comprimiendo...';

            try {
                // Compress
                const compressedBlob = await compressImage(file);

                statusDiv.textContent = '‚è≥ Subiendo...';

                const formData = new FormData();
                // Use original filename but change extension to jpg
                const filename = file.name.replace(/\.[^/.]+$/, "") + ".jpg";
                formData.append('file', compressedBlob, filename);

                let response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    headers: getHeaders()
                });

                response = await handleAuthError(response);

                if (response.ok) {
                    const result = await response.json();
                    statusDiv.className = 'success';
                    statusDiv.textContent = '‚úÖ ¬°Enviado! Procesando en PC...';
                    // Clear inputs
                    fileInput.value = '';
                    galleryInput.value = '';

                    // Reset status after 3s
                    setTimeout(() => {
                        statusDiv.textContent = '';
                    }, 3000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error(error);
                statusDiv.className = 'error';
                statusDiv.textContent = '‚ùå Error al subir la imagen.';
            }
        }

        fileInput.addEventListener('change', async (e) => {
            handleUpload(e.target.files[0]);
        });

        galleryInput.addEventListener('change', async (e) => {
            handleUpload(e.target.files[0]);
        });

        // --- Audio Recording ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;

        const recordBtn = document.getElementById('recordBtn');
        const recordingTime = document.getElementById('recording-time');

        recordBtn.addEventListener('click', async () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Tu navegador no soporta grabaci√≥n de audio.");
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    handleAudioUpload(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                recordBtn.textContent = "‚èπÔ∏è Detener y Enviar";
                recordBtn.style.backgroundColor = "#FF5722";
                recordBtn.style.color = "white";
                recordingTime.style.display = "block";

                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("Error al acceder al micr√≥fono.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = "üéôÔ∏è Grabar Voz";
                recordBtn.style.backgroundColor = "transparent";
                recordBtn.style.color = "#FF5722";
                recordingTime.style.display = "none";
                clearInterval(timerInterval);
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            recordingTime.textContent = `${minutes}:${seconds}`;
        }

        async function handleAudioUpload(audioBlob) {
            statusDiv.className = 'loading';
            statusDiv.textContent = '‚è≥ Subiendo audio...';

            const formData = new FormData();
            formData.append('file', audioBlob, "voice_note.webm");

            try {
                let response = await fetch('/api/upload_audio', {
                    method: 'POST',
                    body: formData,
                    headers: getHeaders()
                });

                response = await handleAuthError(response);

                if (response.ok) {
                    statusDiv.className = 'success';
                    statusDiv.textContent = '‚úÖ Audio enviado. Transcribiendo...';
                    setTimeout(() => { statusDiv.textContent = ''; }, 3000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error(error);
                statusDiv.className = 'error';
                statusDiv.textContent = '‚ùå Error al subir audio.';
            }
        }
    </script>
    <style>
        /* Additions for new views */
        .secondary {
            border-color: #2196F3;
            color: #2196F3;
        }

        .secondary:hover {
            background-color: #2196F3;
            color: white;
        }

        .small {
            padding: 5px 15px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .note-card {
            background: #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .note-card:hover {
            background: #444;
        }

        .status-pending {
            color: orange;
        }

        .status-processed {
            color: #4CAF50;
        }

        .status-error {
            color: #f44336;
        }
    </style>

</body>

</html>