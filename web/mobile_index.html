<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGI Records - Companion</title>

    <!-- iOS / PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MEGI Records">
    <meta name="theme-color" content="#2d3b2d">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/000000/medical-doctor.png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f3ee;
            color: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }

        h1 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            color: #2d3b2d;
            margin-bottom: 4px;
            font-size: 1.6em;
        }

        h2 {
            font-family: 'Cormorant Garamond', Georgia, serif;
            color: #2d3b2d;
            margin: 0;
        }

        p { color: #8a8a8a; margin-bottom: 24px; font-size: 0.9em; }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn {
            border: 2px solid #2d3b2d;
            color: #2d3b2d;
            background-color: transparent;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'DM Sans', sans-serif;
        }

        .btn:hover, .btn:active {
            background-color: #2d3b2d;
            color: white;
        }

        .btn:active { transform: scale(0.97); }

        .btn.secondary {
            border-color: #8b7355;
            color: #8b7355;
        }

        .btn.secondary:hover, .btn.secondary:active {
            background-color: #8b7355;
            color: white;
        }

        .btn.record {
            border-color: #c0392b;
            color: #c0392b;
        }

        .btn.record:hover, .btn.record:active {
            background-color: #c0392b;
            color: white;
        }

        .btn.small {
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 8px;
        }

        input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0; top: 0;
            opacity: 0;
            cursor: pointer;
            height: 100%; width: 100%;
        }

        #status {
            margin-top: 20px;
            font-weight: 600;
            min-height: 24px;
            font-size: 0.9em;
        }

        .success { color: #27ae60; }
        .error { color: #c0392b; }
        .loading { color: #8b7355; }

        .icon { font-size: 40px; margin-bottom: 16px; }

        .note-card {
            background: white;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e8e4dc;
            text-align: left;
        }

        .note-card:hover, .note-card:active {
            border-color: #2d3b2d;
            box-shadow: 0 2px 8px rgba(45,59,45,0.08);
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .tag-consultation { background: #e8f5e9; color: #2d3b2d; }
        .tag-prescription { background: #fff3e0; color: #8b7355; }
        .tag-lab_result { background: #e3f2fd; color: #1565c0; }
        .tag-referral { background: #f3e5f5; color: #7b1fa2; }

        .tag-pending { background: #fff8e1; color: #f57f17; }
        .tag-processing { background: #e3f2fd; color: #1565c0; }
        .tag-processed { background: #e8f5e9; color: #2e7d32; }
        .tag-reviewed { background: #ede7f6; color: #4527a0; }
        .tag-error { background: #ffebee; color: #c62828; }

        .detail-section {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e8e4dc;
            text-align: left;
        }

        .detail-section h4 {
            margin: 0 0 8px 0;
            color: #2d3b2d;
            font-size: 0.95em;
        }

        input[type="text"], input[type="tel"] {
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            padding: 12px 16px;
            text-align: center;
            border-radius: 10px;
            border: 1px solid #d4cfc7;
            background: white;
            color: #1a1a1a;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="tel"]:focus {
            border-color: #2d3b2d;
        }

        .brand-subtitle {
            font-size: 0.7em;
            color: #8b7355;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <!-- Login View -->
    <div id="login-view" style="display:flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 20px;">
        <div class="icon">&#9879;</div>
        <h1>MEGI Records</h1>
        <p class="brand-subtitle" style="margin-bottom: 24px;">Expedientes Medicos</p>
        <p>Ingresa tu Usuario y PIN</p>
        <input type="text" id="userInput" placeholder="Usuario" style="width: 220px; margin-bottom: 10px;">
        <input type="tel" id="pinInput" placeholder="PIN (4 digitos)" maxlength="4" style="width: 160px; margin-bottom: 20px;">
        <button class="btn" onclick="login()">Entrar</button>
        <p id="login-error" class="error" style="display:none; margin-top: 12px; font-size: 0.85em;">Usuario o PIN incorrecto</p>
    </div>

    <!-- Home View -->
    <div id="home-view" style="display:none; padding: 20px;">
        <div class="icon">&#128203;</div>
        <h1>MEGI Records</h1>
        <p>Captura documentos medicos</p>

        <div class="upload-btn-wrapper">
            <button class="btn">&#128247; Tomar Foto</button>
            <input type="file" name="file" id="fileInput" accept="image/*" capture="environment">
        </div>

        <div class="upload-btn-wrapper" style="margin-top: 12px;">
            <button class="btn secondary">&#128444; Galeria</button>
            <input type="file" name="file" id="galleryInput" accept="image/*">
        </div>

        <div class="upload-btn-wrapper" style="margin-top: 12px;">
            <button id="recordBtn" class="btn record">&#127908; Grabar Voz</button>
        </div>
        <p id="recording-time" style="display:none; color: #c0392b; font-weight: bold; margin-top: 6px; font-size: 0.9em;">00:00</p>

        <br><br>
        <button class="btn secondary" onclick="showConsultationsList()">&#128194; Ver Expedientes</button>
        <br><br>
        <button class="btn small" onclick="logout()" style="background:none; border:none; color:#8a8a8a; font-size:12px; cursor:pointer;">Cerrar Sesion</button>

        <div id="status"></div>
    </div>

    <!-- List View -->
    <div id="list-view" style="display:none; width: 100%; max-width: 600px; height: 100vh; overflow-y: auto; padding: 0 16px;">
        <div style="position: sticky; top: 0; background: #f5f3ee; padding: 16px 0 10px 0; z-index: 100; border-bottom: 1px solid #e8e4dc;">
            <button class="btn small" onclick="showHome()" style="margin-bottom: 6px;">&#8592; Volver</button>
            <h2>Expedientes</h2>
        </div>
        <div id="consultations-container" style="padding-top: 10px; padding-bottom: 20px;"></div>
    </div>

    <!-- Detail View -->
    <div id="detail-view" style="display:none; width: 100%; max-width: 600px; height: 100vh; overflow-y: auto; padding: 0 16px;">
        <div style="position: sticky; top: 0; background: #f5f3ee; padding: 16px 0 10px 0; z-index: 100; border-bottom: 1px solid #e8e4dc;">
            <button class="btn small" onclick="showConsultationsList()" style="margin-bottom: 6px;">&#8592; Volver</button>
            <h2 id="detail-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Detalle</h2>
        </div>
        <div id="detail-content" style="word-wrap: break-word; overflow-wrap: break-word; padding-top: 16px; padding-bottom: 20px;"></div>
    </div>

    <script>
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const fileInput = document.getElementById('fileInput');
        const galleryInput = document.getElementById('galleryInput');
        const statusDiv = document.getElementById('status');
        let currentPIN = localStorage.getItem('megi_pin');
        let currentUser = localStorage.getItem('megi_user');
        let ws = null;

        if (currentPIN && currentUser) {
            showHome();
            connectWebSocket();
        }

        async function login() {
            const pin = document.getElementById('pinInput').value;
            const user = document.getElementById('userInput').value;

            if (pin.length !== 4 || user.length === 0) {
                document.getElementById('login-error').textContent = 'Ingresa usuario y PIN de 4 digitos';
                document.getElementById('login-error').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'X-Auth-User': user, 'X-Auth-PIN': pin }
                });

                if (response.ok) {
                    currentPIN = pin;
                    currentUser = user;
                    localStorage.setItem('megi_pin', pin);
                    localStorage.setItem('megi_user', user);
                    document.getElementById('login-error').style.display = 'none';
                    showHome();
                    connectWebSocket();
                } else {
                    document.getElementById('login-error').textContent = 'Usuario o PIN incorrecto';
                    document.getElementById('login-error').style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').textContent = 'Error de conexion. Intenta de nuevo.';
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('megi_pin');
            localStorage.removeItem('megi_user');
            if (ws) ws.close();
            location.reload();
        }

        function getHeaders() {
            return { 'X-Auth-PIN': currentPIN, 'X-Auth-User': currentUser };
        }

        async function handleAuthError(response) {
            if (response.status === 401) {
                alert("Sesion expirada o PIN incorrecto");
                logout();
                throw new Error("Unauthorized");
            }
            return response;
        }

        // WebSocket
        function connectWebSocket() {
            if (!currentUser) return;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/${currentUser}`);

            ws.onopen = () => {
                console.log("WebSocket connected");
                setInterval(() => { if (ws.readyState === WebSocket.OPEN) ws.send("ping"); }, 30000);
            };

            ws.onmessage = (event) => {
                if (event.data === "pong") return;
                if (event.data === "processing_complete") {
                    showToast("Procesamiento completado");
                    if (document.getElementById('list-view').style.display === 'block') {
                        showConsultationsList();
                    }
                }
            };

            ws.onclose = () => {
                console.log("WebSocket disconnected. Reconnecting...");
                setTimeout(connectWebSocket, 5000);
            };
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            Object.assign(toast.style, {
                position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                background: '#2d3b2d', color: 'white', padding: '10px 20px', borderRadius: '10px',
                zIndex: '1000', boxShadow: '0 4px 12px rgba(0,0,0,0.15)', fontSize: '0.9em'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Navigation
        function showHome() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'none';
        }

        function getDocTypeLabel(type) {
            const labels = { consultation: 'Consulta', prescription: 'Receta', lab_result: 'Laboratorio', referral: 'Referencia' };
            return labels[type] || type;
        }

        function getStatusLabel(status) {
            const labels = { pending: 'Pendiente', processing: 'En Proceso', processed: 'Procesado', reviewed: 'Revisado', error: 'Error' };
            return labels[status] || status;
        }

        async function showConsultationsList() {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'block';
            document.getElementById('detail-view').style.display = 'none';

            const container = document.getElementById('consultations-container');
            container.innerHTML = '<p class="loading" style="text-align:center; padding:40px 0;">Cargando expedientes...</p>';

            try {
                let response = await fetch('/api/consultations', { headers: getHeaders() });
                response = await handleAuthError(response);
                const consultations = await response.json();

                container.innerHTML = '';
                if (consultations.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding:40px 0;">Sin expedientes aun.</p>';
                    return;
                }

                consultations.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    const summary = c.summary || 'Sin resumen';
                    const docType = c.document_type || 'consultation';
                    const status = c.status || 'pending';

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 6px;">
                            <span class="tag tag-${docType}">${getDocTypeLabel(docType)}</span>
                            <span class="tag tag-${status}">${getStatusLabel(status)}</span>
                        </div>
                        <p style="font-size: 0.9em; color: #1a1a1a; margin: 4px 0; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${escapeHtml(summary)}</p>
                        <p style="font-size: 0.75em; color: #8a8a8a; margin-top: 4px;">
                            ${c.created_at ? new Date(c.created_at.replace(' ', 'T')).toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }) : ''}
                        </p>
                    `;
                    card.onclick = () => showConsultationDetail(c.id);
                    container.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="error" style="text-align:center; padding:20px;">Error al cargar expedientes.</p>';
            }
        }

        async function showConsultationDetail(id) {
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';

            const content = document.getElementById('detail-content');
            const titleEl = document.getElementById('detail-title');
            content.innerHTML = '<p class="loading" style="text-align:center; padding:40px 0;">Cargando...</p>';

            try {
                let response = await fetch(`/api/consultations/${id}`, { headers: getHeaders() });
                response = await handleAuthError(response);
                const data = await response.json();

                const analysis = data.ai_analysis || {};
                const docType = data.document_type || 'consultation';
                const status = data.status || 'pending';
                titleEl.textContent = getDocTypeLabel(docType) + ' #' + data.id;

                // Patient info
                let patientHtml = '';
                if (data.patient) {
                    patientHtml = `
                        <div class="detail-section">
                            <h4>&#128100; Paciente</h4>
                            <p style="font-weight:600; margin-bottom:4px;">${escapeHtml(data.patient.name)}</p>
                            <p style="font-size:0.8em; color:#8a8a8a;">
                                ${data.patient.gender || ''} ${data.patient.blood_type ? '| ' + data.patient.blood_type : ''}
                            </p>
                        </div>
                    `;
                }

                // SOAP sections
                const subjective = analysis.subjective || {};
                const objective = analysis.objective || {};
                const assessment = analysis.assessment || {};
                const plan = analysis.plan || {};

                let soapHtml = '';

                // Subjective
                if (subjective.chief_complaint || (subjective.symptoms && subjective.symptoms.length)) {
                    soapHtml += `<div class="detail-section">
                        <h4>S - Subjetivo</h4>
                        ${subjective.chief_complaint ? `<p style="font-size:0.85em; margin-bottom:6px;"><strong>Motivo:</strong> ${escapeHtml(subjective.chief_complaint)}</p>` : ''}
                        ${subjective.symptoms && subjective.symptoms.length ? `<p style="font-size:0.85em;"><strong>Sintomas:</strong> ${subjective.symptoms.map(s => escapeHtml(s)).join(', ')}</p>` : ''}
                    </div>`;
                }

                // Objective
                const vitals = objective.vitals || {};
                const hasVitals = Object.values(vitals).some(v => v);
                if (hasVitals || (objective.findings && objective.findings.length)) {
                    soapHtml += `<div class="detail-section">
                        <h4>O - Objetivo</h4>
                        ${hasVitals ? `<div style="display:grid; grid-template-columns:1fr 1fr; gap:4px; font-size:0.8em; margin-bottom:8px;">
                            ${vitals.blood_pressure ? `<span>PA: ${vitals.blood_pressure}</span>` : ''}
                            ${vitals.heart_rate ? `<span>FC: ${vitals.heart_rate}</span>` : ''}
                            ${vitals.temperature ? `<span>Temp: ${vitals.temperature}</span>` : ''}
                            ${vitals.weight ? `<span>Peso: ${vitals.weight}</span>` : ''}
                            ${vitals.spo2 ? `<span>SpO2: ${vitals.spo2}</span>` : ''}
                        </div>` : ''}
                        ${objective.findings && objective.findings.length ? `<p style="font-size:0.85em;"><strong>Hallazgos:</strong> ${objective.findings.map(f => escapeHtml(f)).join(', ')}</p>` : ''}
                    </div>`;
                }

                // Assessment
                const diagnoses = assessment.diagnoses || [];
                if (diagnoses.length) {
                    soapHtml += `<div class="detail-section">
                        <h4>A - Evaluacion</h4>
                        ${diagnoses.map(d => `<p style="font-size:0.85em; margin-bottom:4px;">
                            ${escapeHtml(d.description)} ${d.cie10_code ? `<span class="tag" style="background:#e3f2fd; color:#1565c0;">${escapeHtml(d.cie10_code)}</span>` : ''}
                        </p>`).join('')}
                    </div>`;
                }

                // Plan
                const medications = plan.medications || [];
                if (medications.length || plan.recommendations) {
                    soapHtml += `<div class="detail-section">
                        <h4>P - Plan</h4>
                        ${medications.length ? '<p style="font-size:0.85em; font-weight:600; margin-bottom:4px;">Medicamentos:</p>' +
                            medications.map(m => `<p style="font-size:0.8em; margin-left:8px; margin-bottom:4px;">
                                &#128138; ${escapeHtml(m.drug_name)} ${m.dose ? '- ' + escapeHtml(m.dose) : ''} ${m.frequency ? '| ' + escapeHtml(m.frequency) : ''} ${m.duration ? '| ' + escapeHtml(m.duration) : ''}
                            </p>`).join('') : ''}
                        ${plan.follow_up ? `<p style="font-size:0.8em; margin-top:8px;"><strong>Seguimiento:</strong> ${escapeHtml(plan.follow_up)}</p>` : ''}
                    </div>`;
                }

                // Summary & confidence
                const summary = analysis.summary || data.summary || '';
                const confidence = analysis.confidence_score || 0;

                let summaryHtml = '';
                if (summary) {
                    summaryHtml = `<div class="detail-section">
                        <h4>Resumen</h4>
                        <p style="font-size:0.85em; line-height:1.5;">${escapeHtml(summary)}</p>
                        ${confidence ? `<p style="font-size:0.75em; color:#8b7355; margin-top:8px;">Confianza: ${confidence}%</p>` : ''}
                    </div>`;
                }

                // Status & type
                let headerHtml = `<div style="display:flex; gap:8px; margin-bottom:12px;">
                    <span class="tag tag-${docType}">${getDocTypeLabel(docType)}</span>
                    <span class="tag tag-${status}">${getStatusLabel(status)}</span>
                </div>`;

                content.innerHTML = headerHtml + patientHtml + summaryHtml + soapHtml;

                // Raw text
                if (data.raw_text) {
                    content.innerHTML += `<div class="detail-section">
                        <h4>Texto Extraido</h4>
                        <p style="font-size:0.8em; line-height:1.5; white-space:pre-wrap; color:#5a5a5a;">${escapeHtml(data.raw_text)}</p>
                    </div>`;
                }

            } catch (e) {
                console.error(e);
                content.innerHTML = '<p class="error" style="text-align:center;">Error al cargar detalle.</p>';
            }
        }

        // Image compression
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        const max = 1920;
                        if (w > h) { if (w > max) { h *= max / w; w = max; } }
                        else { if (h > max) { w *= max / h; h = max; } }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function handleUpload(file) {
            if (!file) return;
            statusDiv.className = 'loading';
            statusDiv.textContent = 'Comprimiendo...';

            try {
                const compressed = await compressImage(file);
                statusDiv.textContent = 'Subiendo documento...';

                const formData = new FormData();
                formData.append('file', compressed, file.name.replace(/\.[^/.]+$/, "") + ".jpg");

                let response = await fetch('/api/upload', { method: 'POST', body: formData, headers: getHeaders() });
                response = await handleAuthError(response);

                if (response.ok) {
                    statusDiv.className = 'success';
                    statusDiv.textContent = 'Documento enviado. Procesando...';
                    fileInput.value = '';
                    galleryInput.value = '';
                    setTimeout(() => { statusDiv.textContent = ''; }, 3000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error(error);
                statusDiv.className = 'error';
                statusDiv.textContent = 'Error al subir documento.';
            }
        }

        fileInput.addEventListener('change', (e) => handleUpload(e.target.files[0]));
        galleryInput.addEventListener('change', (e) => handleUpload(e.target.files[0]));

        // Audio recording
        let mediaRecorder, audioChunks = [], isRecording = false, startTime, timerInterval;
        const recordBtn = document.getElementById('recordBtn');
        const recordingTime = document.getElementById('recording-time');

        recordBtn.addEventListener('click', () => {
            isRecording ? stopRecording() : startRecording();
        });

        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Tu navegador no soporta grabacion de audio.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    handleAudioUpload(audioBlob);
                };
                mediaRecorder.start();
                isRecording = true;
                recordBtn.textContent = "Detener y Enviar";
                recordBtn.style.backgroundColor = "#c0392b";
                recordBtn.style.color = "white";
                recordingTime.style.display = "block";
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
            } catch (err) {
                console.error(err);
                alert("Error al acceder al microfono.");
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = "&#127908; Grabar Voz";
                recordBtn.style.backgroundColor = "transparent";
                recordBtn.style.color = "#c0392b";
                recordingTime.style.display = "none";
                clearInterval(timerInterval);
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            recordingTime.textContent = `${String(Math.floor(elapsed / 60)).padStart(2, '0')}:${String(elapsed % 60).padStart(2, '0')}`;
        }

        async function handleAudioUpload(audioBlob) {
            statusDiv.className = 'loading';
            statusDiv.textContent = 'Subiendo audio...';

            const formData = new FormData();
            formData.append('file', audioBlob, "voice_note.webm");

            try {
                let response = await fetch('/api/upload_audio', { method: 'POST', body: formData, headers: getHeaders() });
                response = await handleAuthError(response);

                if (response.ok) {
                    statusDiv.className = 'success';
                    statusDiv.textContent = 'Audio enviado. Transcribiendo...';
                    setTimeout(() => { statusDiv.textContent = ''; }, 3000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error(error);
                statusDiv.className = 'error';
                statusDiv.textContent = 'Error al subir audio.';
            }
        }
    </script>
</body>

</html>
